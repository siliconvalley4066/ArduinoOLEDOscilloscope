2021/08/19 GOscillo with Pulse generator and DDS Function generator

■Known Bugs

波形表示が所々途切れることがある。

0.5s/divレンジ以上でFFT表示にならない。そもそもそのようにコーディングしていないし直す気は無い。

原理的に周波数測定には画面上で2周期以上が必要。

周波数測定と電圧測定はCH1のみ。CH2のみ表示でもCH1の測定値が出る。

トリガモードのOneがうまく機能しないので外してある。

トリガが掛からない状態でトリガモードをNormにすると、トリガ検出から抜け出せなくなり操作不能になる。トリガが掛かる入力を入れれば復帰する。

2ch表示で信号源インピーダンスが大きい場合は(目安として100kohm以上で入力無接続や10:1プローブ接続を含む)相互に観測波形に影響が出る。入力インピーダンスが下がるのを許容して入力回路の抵抗値2Mohmを100kohm以下に下げれば軽減できると思う。

1ch表示でも信号源インピーダンスが大きい場合はトリガーソースを他チャンネルにすると波形の最初が乱れる。

2ch間でレベル差が大きい部分には相互干渉が発生することがある。

等価時間サンプリングでは50usecのディレイトリガ固定にしている。

等価時間サンプリングではCH1のみの計測だが、CH2をOnにするとCH2の波形を表示する。極性の反転はCH1側の設定に従う。実際の波形の取り込みはどちらか一方しかしない。

ATMEGA328の性能限界のため、実時間サンプリングの100us/divレンジ以下では実効分解能が6bit以下になる。500us/divレンジでも8bit未満になる。そのために波形がつぶれて見える。

等価時間サンプリングではTimer1とTimer2を使うので、Timer1を使うPulse generatorとDDSと周波数カウンタは使えない。

等価時間サンプリングの特定の周波数でトリガが不安定になる。

一旦等価時間サンプリングにするとPulse generatorとDDSのレジスタ設定が壊れる。実時間サンプリングに戻してから再びONにすれば復帰する。

ADC入力の保護保護抵抗を省略したのでATMEGAが壊れやすいかもしれない。

Pulse generatorはCPUクロックを分周していて1/2から整数分の1の周波数を発生する。周波数の高い方は8MHz, 5.33MHz, 4MHz, 3.2MHz, 2.67MHzのように飛び飛びの値になる。Duty cycleも実現可能な値が限られていて50%も不可能な場合がある。周波数の低い側の分解能は1/65536になる。

DDS Function Generatorは31kHzで割込みが頻繁にかかるので、CPU実行時間に依存する時間軸レンジではOscilloscopeのサンプリング時間に誤差が出る。特に580usと200us以下ではDDSをOFFにしないと誤差が大きい。

実時間サンプリングではこれ単体で2チャンネル入力にPulse generatorとDDS Function Generatorの出力を入れて波形観測して遊べますが、等価時間サンプリングではD3ピンから62.5kHzが出ているのでトリガレベルを変えてパルス幅が変わることを確認できます。

■改良可能性

電源電圧を測定して電圧を表示・補正。特にArduino NanoではUSB給電時は逆流防止のダイオードが入るので電源電圧が4.7V程度になるので補正した方が良い。

内部基準電圧1.1Vを使って電圧感度アップ。

Hold Off調整機能を入れた方が便利かもしれない。

等価時間サンプリングでのディレイトリガのディレイ量を変更できるようにUIを追加したい。

特に等価時間サンプリングの時間軸が中途半端な値になっているので、スケーリングしてきりの良い値にしたい。水平軸の目盛の縦線の間隔を変えてもいいかもしれません。

A2, A3, A6, A7ピンが余っているので何かに使えるかも。

とは言え、スケッチが30602バイト、UNOで94%、Nanoで99%なので何かを加えると何かを削る必要がある。
